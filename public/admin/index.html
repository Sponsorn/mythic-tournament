<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M+ Tournament - Admin Dashboard</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <div class="admin-container">
    <header class="admin-header">
      <div>
        <h1 class="admin-title">M+ Tournament Admin</h1>
        <p class="admin-subtitle">Manage teams, monitor runs, and control the tournament</p>
      </div>
      <div class="connection-badge" id="connectionBadge">
        <span class="status-dot"></span>
        <span id="connectionText">Connecting...</span>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="admin-nav">
      <a href="/admin/" class="nav-link active">Dashboard</a>
      <a href="/admin/leaderboard.html" class="nav-link">Leaderboard</a>
      <a href="/admin/best-times.html" class="nav-link">Best Times</a>
      <a href="/admin/team-runs.html" class="nav-link">Team Runs</a>
      <a href="/admin/links.html" class="nav-link">Links</a>
    </nav>

    <!-- Status Cards -->
    <div class="status-grid">
      <div class="status-card" id="teamsCard">
        <div class="label">Teams</div>
        <div class="value" id="teamsCount">0</div>
      </div>
      <div class="status-card" id="activeCard">
        <div class="label">Active Runs</div>
        <div class="value" id="activeCount">0</div>
      </div>
      <div class="status-card" id="quotaCard">
        <div class="label">API Quota</div>
        <div class="value" id="quotaUsage">0/3600</div>
      </div>
      <div class="status-card" id="statusCard">
        <div class="label">Tournament</div>
        <div class="value" id="tournamentStatus">--</div>
      </div>
    </div>

    <!-- Tournament Controls -->
    <div class="controls-section">
      <h2 class="section-title">Tournament Controls</h2>
      <div class="control-buttons">
        <button class="btn btn-success" id="resumeBtn">Resume Polling</button>
        <button class="btn btn-warning" id="pauseBtn">Pause Polling</button>
        <button class="btn btn-secondary" id="refreshAllBtn">Force Refresh All</button>
      </div>
    </div>

    <!-- Teams Table -->
    <div class="teams-section">
      <div class="teams-header">
        <h2 class="section-title" style="margin: 0;">Teams</h2>
      </div>
      <table class="teams-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Team Name</th>
            <th>Bracket</th>
            <th>Score</th>
            <th>Active</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="teamsBody">
          <tr>
            <td colspan="7" style="text-align: center; color: var(--text-muted);">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Recent Runs -->
    <div class="recent-section">
      <div class="recent-header">
        <h2 class="section-title" style="margin: 0;">Recent Completed Runs</h2>
      </div>
      <div class="recent-list" id="recentList">
        <div class="recent-item" style="justify-content: center; color: var(--text-muted);">
          No completed runs yet
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Team</h3>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editOriginalName">
        <div class="form-group">
          <label class="form-label">Team Name</label>
          <input type="text" class="input" id="editTeamName" placeholder="Team name">
        </div>
        <div class="form-group">
          <label class="form-label">Leader Name</label>
          <input type="text" class="input" id="editLeaderName" placeholder="Team leader name">
        </div>
        <div class="form-group">
          <label class="form-label">Bracket</label>
          <select class="input" id="editBracket">
            <option value="A">Bracket A</option>
            <option value="B">Bracket B</option>
            <option value="C">Bracket C</option>
            <option value="D">Bracket D</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Primary Report Code (URL or 16-char code)</label>
          <input type="text" class="input" id="editReportCode" placeholder="https://www.warcraftlogs.com/reports/...">
        </div>
        <div class="form-group">
          <label class="form-label">Backup Report Code (optional)</label>
          <input type="text" class="input" id="editBackupCode" placeholder="Optional backup report">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
        <button class="btn btn-primary" id="saveEditBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Run Details Modal -->
  <div class="modal-overlay" id="runDetailsModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Run Details</h3>
      </div>
      <div class="modal-body">
        <input type="hidden" id="runDetailsTeamName">
        <div class="form-group">
          <label class="form-label">Team</label>
          <div class="input" id="runDetailsTeamDisplay" style="background: var(--bg-secondary); cursor: default;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Dungeon</label>
          <select class="input" id="runDetailsDungeon">
            <option value="">Loading dungeons...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Key Level</label>
          <input type="number" class="input" id="runDetailsKeyLevel" value="15" min="2" max="40">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRunDetailsBtn">Cancel</button>
        <button class="btn btn-success" id="saveRunDetailsBtn">Save Details</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/socket-client.js"></script>
  <script>
    const adminSecret = new URLSearchParams(window.location.search).get('secret') || '';
    const client = new TournamentClient({ secret: adminSecret });

    // DOM Elements
    const connectionBadge = document.getElementById('connectionBadge');
    const connectionText = document.getElementById('connectionText');
    const teamsCount = document.getElementById('teamsCount');
    const activeCount = document.getElementById('activeCount');
    const quotaUsage = document.getElementById('quotaUsage');
    const quotaCard = document.getElementById('quotaCard');
    const tournamentStatus = document.getElementById('tournamentStatus');
    const teamsBody = document.getElementById('teamsBody');
    const recentList = document.getElementById('recentList');
    const editModal = document.getElementById('editModal');
    const toastContainer = document.getElementById('toastContainer');

    // State
    let teams = [];
    let leaderboard = [];
    let recentRuns = [];
    let activeRuns = [];
    let dungeonList = [];

    // Connection events
    client.on('connected', () => {
      connectionBadge.classList.add('connected');
      connectionBadge.classList.remove('disconnected');
      connectionText.textContent = 'Connected';
    });

    client.on('disconnected', () => {
      connectionBadge.classList.add('disconnected');
      connectionBadge.classList.remove('connected');
      connectionText.textContent = 'Disconnected';
    });

    // State sync
    client.on('state:sync', (state) => {
      teams = state.teams || [];
      leaderboard = state.leaderboard || [];
      recentRuns = state.recentRuns || [];
      activeRuns = state.activeRuns || [];

      updateStatusCards(state);
      renderTeams();
      renderRecentRuns();
      loadDungeonList();
    });

    client.on('activeRuns:update', (newActiveRuns) => {
      activeRuns = newActiveRuns;
      activeCount.textContent = activeRuns.length;
      renderTeams();
    });

    client.on('teams:update', (newTeams) => {
      teams = newTeams;
      renderTeams();
    });

    client.on('scoreboard:update', (newLeaderboard) => {
      leaderboard = newLeaderboard;
      renderTeams();
    });

    client.on('quota:update', (quota) => {
      updateQuota(quota);
    });

    client.on('run:complete', (data) => {
      recentRuns.unshift(data.recap);
      if (recentRuns.length > 10) recentRuns = recentRuns.slice(0, 10);
      renderRecentRuns();
    });

    client.on('tournament:status', (data) => {
      tournamentStatus.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
    });

    client.on('admin:response', (response) => {
      showToast(response.message, response.success ? 'success' : 'error');
    });

    // Update functions
    function updateStatusCards(state) {
      teamsCount.textContent = state.teams?.length || 0;
      activeCount.textContent = state.activeRuns?.length || 0;
      tournamentStatus.textContent = state.tournament?.status || 'Unknown';
      updateQuota(state.apiQuota);
    }

    function updateQuota(quota) {
      if (!quota) return;
      const used = quota.used || 0;
      const limit = quota.limit || 3600;
      const percentage = (used / limit) * 100;

      quotaUsage.textContent = `${used}/${limit}`;
      quotaCard.classList.remove('warning', 'ok');
      quotaCard.classList.add(percentage >= 80 ? 'warning' : 'ok');
    }

    function renderTeams() {
      if (!teams.length) {
        teamsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No teams registered</td></tr>';
        return;
      }

      const html = teams.map(team => {
        const entry = leaderboard.find(e => e.teamName === team.name);
        const score = entry?.points || 0;
        const activeRun = activeRuns.find(r => r.teamName === team.name);
        const isRunning = !!activeRun;
        const bracket = team.bracket || 'A';
        const hasDungeonDetails = activeRun && activeRun.dungeonName;

        // Run info display (inline after Details button)
        let runStatusText = '';
        if (isRunning) {
          if (hasDungeonDetails) {
            runStatusText = `<span class="run-details-text">${escapeHtml(activeRun.dungeonName)} +${activeRun.keystoneLevel}</span>`;
          } else {
            runStatusText = `<span class="run-details-pending">Waiting for details</span>`;
          }
        }

        return `
          <tr data-team="${escapeHtml(team.name)}">
            <td class="team-number">${team.id || '-'}</td>
            <td class="team-name-cell">${escapeHtml(team.name)}</td>
            <td class="team-bracket"><span class="bracket-badge bracket-${bracket.toLowerCase()}">${bracket}</span></td>
            <td class="score-cell">${getScoreMedal(entry?.rank)}${score.toLocaleString()}</td>
            <td class="team-active-cell">
              <div class="active-toggle-row">
                <label class="toggle-switch">
                  <input type="checkbox" ${isRunning ? 'checked' : ''} data-action="toggleActive" data-team="${escapeHtml(team.name)}">
                  <span class="toggle-slider"></span>
                </label>
                <button class="btn btn-secondary btn-sm" data-action="runDetails" data-team="${escapeHtml(team.name)}" ${!isRunning ? 'disabled' : ''}>Details</button>
                ${runStatusText}
              </div>
            </td>
            <td class="team-actions">
              <button class="btn btn-secondary btn-sm" data-action="edit" data-team="${escapeHtml(team.name)}">Edit</button>
              <button class="btn btn-primary btn-sm" data-action="refresh" data-team="${escapeHtml(team.name)}">Refresh</button>
            </td>
          </tr>
        `;
      }).join('');

      teamsBody.innerHTML = html;
    }

    function renderRecentRuns() {
      if (!recentRuns.length) {
        recentList.innerHTML = '<div class="recent-item" style="justify-content: center; color: var(--text-muted);">No completed runs yet</div>';
        return;
      }

      const html = recentRuns.map((run, index) => {
        const timedClass = run.timed ? 'timed' : 'depleted';
        return `
          <div class="recent-item">
            <div class="recent-info">
              <div class="recent-team">${escapeHtml(run.teamName)}</div>
              <div class="recent-dungeon">${escapeHtml(run.dungeonName)} +${run.keystoneLevel}</div>
              <div class="recent-details">
                ${formatTime(run.duration)} | ${run.deaths} deaths | ${run.timed ? 'Timed' : 'Depleted'}
              </div>
            </div>
            <div class="recent-points">${run.points}</div>
          </div>
        `;
      }).join('');

      recentList.innerHTML = html;
    }

    // Control buttons
    document.getElementById('resumeBtn').addEventListener('click', () => {
      client.resumeTournament();
    });

    document.getElementById('pauseBtn').addEventListener('click', () => {
      client.pauseTournament();
    });

    document.getElementById('refreshAllBtn').addEventListener('click', () => {
      teams.forEach(team => {
        client.forceRefresh(team.name);
      });
      showToast('Refreshing all teams...', 'success');
    });

    // Edit modal
    function editTeam(teamName) {
      const team = teams.find(t => t.name === teamName);
      const code = extractCode(team?.wclUrl);
      const backupCode = extractCode(team?.wclBackupUrl);
      document.getElementById('editOriginalName').value = teamName;
      document.getElementById('editTeamName').value = teamName;
      document.getElementById('editLeaderName').value = team?.leaderName || '';
      document.getElementById('editBracket').value = team?.bracket || 'A';
      document.getElementById('editReportCode').value = code || '';
      document.getElementById('editBackupCode').value = backupCode || '';
      editModal.classList.add('visible');
    }

    document.getElementById('cancelEditBtn').addEventListener('click', () => {
      editModal.classList.remove('visible');
    });

    document.getElementById('saveEditBtn').addEventListener('click', () => {
      const originalName = document.getElementById('editOriginalName').value;
      const newTeamName = document.getElementById('editTeamName').value.trim();
      const leaderName = document.getElementById('editLeaderName').value.trim();
      const bracket = document.getElementById('editBracket').value;
      const reportCode = document.getElementById('editReportCode').value;
      const backupCode = document.getElementById('editBackupCode').value;

      if (!newTeamName) {
        showToast('Team name is required', 'error');
        return;
      }

      client.updateTeam(originalName, newTeamName, leaderName, reportCode, backupCode || null, bracket);
      editModal.classList.remove('visible');
    });

    // Click outside modal to close
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        editModal.classList.remove('visible');
      }
    });

    // Team actions
    function refreshTeam(teamName) {
      client.forceRefresh(teamName);
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('exiting');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Utility functions
    function getScoreMedal(rank) {
      if (rank === 1) return '<span class="score-medal score-medal-gold">1</span>';
      if (rank === 2) return '<span class="score-medal score-medal-silver">2</span>';
      if (rank === 3) return '<span class="score-medal score-medal-bronze">3</span>';
      return '';
    }

    function extractCode(url) {
      if (!url) return '';
      const match = url.match(/\/reports\/([A-Za-z0-9]{16})/);
      return match ? match[1] : url.substring(0, 16);
    }


    // Run Details modal elements
    const runDetailsModal = document.getElementById('runDetailsModal');
    const runDetailsTeamName = document.getElementById('runDetailsTeamName');
    const runDetailsTeamDisplay = document.getElementById('runDetailsTeamDisplay');
    const runDetailsDungeon = document.getElementById('runDetailsDungeon');
    const runDetailsKeyLevel = document.getElementById('runDetailsKeyLevel');

    // Load dungeon list from API
    async function loadDungeonList() {
      if (dungeonList.length > 0) return; // Already loaded

      try {
        const response = await fetch('/api/dungeon-pars');
        const pars = await response.json();
        dungeonList = Object.keys(pars).map(slug => ({
          slug,
          name: slug.split('-').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
          ).join(' ')
        }));

        // Populate dropdown
        runDetailsDungeon.innerHTML = dungeonList.map(d =>
          `<option value="${d.slug}">${d.name}</option>`
        ).join('');
      } catch (err) {
        console.error('Failed to load dungeon list:', err);
        runDetailsDungeon.innerHTML = '<option value="">Error loading dungeons</option>';
      }
    }

    // Toggle active state
    function toggleActive(teamName, active) {
      client.toggleActiveRun(teamName, active);
    }

    // Open Run Details modal
    function openRunDetailsModal(teamName) {
      const activeRun = activeRuns.find(r => r.teamName === teamName);
      if (!activeRun) {
        showToast('Team must be active first', 'error');
        return;
      }

      runDetailsTeamName.value = teamName;
      runDetailsTeamDisplay.textContent = teamName;
      runDetailsKeyLevel.value = activeRun.keystoneLevel || 15;

      // Select current dungeon if set
      if (activeRun.dungeonName && dungeonList.length > 0) {
        const slug = activeRun.dungeonName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        const option = Array.from(runDetailsDungeon.options).find(o => o.value === slug);
        if (option) {
          runDetailsDungeon.value = slug;
        } else {
          runDetailsDungeon.selectedIndex = 0;
        }
      } else if (dungeonList.length > 0) {
        runDetailsDungeon.selectedIndex = 0;
      }

      runDetailsModal.classList.add('visible');
    }

    // Run Details modal event listeners
    document.getElementById('cancelRunDetailsBtn').addEventListener('click', () => {
      runDetailsModal.classList.remove('visible');
    });

    document.getElementById('saveRunDetailsBtn').addEventListener('click', () => {
      const teamName = runDetailsTeamName.value;
      const dungeonSlug = runDetailsDungeon.value;
      const dungeonName = dungeonList.find(d => d.slug === dungeonSlug)?.name || dungeonSlug;
      const keyLevel = parseInt(runDetailsKeyLevel.value) || 15;

      if (!teamName || !dungeonSlug) {
        showToast('Please select a dungeon', 'error');
        return;
      }

      client.setRunDetails(teamName, dungeonName, keyLevel);
      runDetailsModal.classList.remove('visible');
    });

    // Click outside modal to close
    runDetailsModal.addEventListener('click', (e) => {
      if (e.target === runDetailsModal) {
        runDetailsModal.classList.remove('visible');
      }
    });

    // Event delegation for teams table and recent runs
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const teamName = btn.dataset.team;

      switch (action) {
        case 'edit':
          editTeam(teamName);
          break;
        case 'refresh':
          refreshTeam(teamName);
          break;
        case 'runDetails':
          openRunDetailsModal(teamName);
          break;
      }
    });

    document.addEventListener('change', (e) => {
      const input = e.target.closest('[data-action="toggleActive"]');
      if (!input) return;
      toggleActive(input.dataset.team, input.checked);
    });
  </script>
</body>
</html>
