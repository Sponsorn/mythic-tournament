<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M+ Tournament - Active Runs</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/active-runs.css">
</head>
<body>
  <div class="active-runs" id="activeRuns">
    <div class="active-runs-header">
      <div class="active-runs-title">
        Active Runs
        <span class="count" id="runCount">0</span>
      </div>
    </div>

    <div class="active-runs-body" id="runsList">
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/socket-client.js"></script>
  <script>
    const client = initTournamentClient();
    const runsListEl = document.getElementById('runsList');
    const runCountEl = document.getElementById('runCount');

    // Timer update interval
    let timerInterval = null;

    client.on('state:sync', (state) => {
      renderActiveRuns(state.activeRuns);
      startTimerUpdates();
    });

    client.on('activeRuns:update', (activeRuns) => {
      renderActiveRuns(activeRuns);
    });

    client.on('run:progress', (data) => {
      updateRunProgress(data);
    });

    function renderActiveRuns(runs) {
      runCountEl.textContent = runs.length;

      if (!runs || runs.length === 0) {
        runsListEl.innerHTML = '';
        return;
      }

      const html = runs.map(run => createRunCard(run)).join('');
      runsListEl.innerHTML = html;
    }

    function createRunCard(run) {
      const elapsed = run.progress?.elapsed || (Date.now() - run.startTime);
      const percentage = run.progress?.percentage || 0;
      const bossesKilled = run.progress?.bossesKilled || 0;
      const totalBosses = run.progress?.totalBosses || 3;
      const deaths = run.deaths || 0;

      const timerClass = getTimerClass(elapsed, run.parTime);
      const deathsClass = deaths === 0 ? 'zero' : '';

      const bossMarkers = Array.from({ length: totalBosses }, (_, i) => {
        return `<div class="boss-marker ${i < bossesKilled ? 'killed' : ''}"></div>`;
      }).join('');

      return `
        <div class="run-card" data-run-id="${run.id}" data-start="${run.startTime}" data-par="${run.parTime}">
          <div class="run-header">
            <div>
              <div class="run-team">${escapeHtml(run.teamName)}</div>
              <div class="run-dungeon">
                ${escapeHtml(run.dungeonName)}
                <span class="run-level">+${run.keystoneLevel}</span>
              </div>
            </div>
          </div>

          <div class="run-progress">
            <div class="progress-header">
              <span class="progress-percentage">${percentage.toFixed(0)}%</span>
              <span class="progress-timer ${timerClass}" data-elapsed="${elapsed}">
                ${formatTime(elapsed)} / ${formatTime(run.parTime)}
              </span>
            </div>
            <div class="progress-bar">
              <div class="fill" style="width: ${percentage}%"></div>
            </div>
          </div>

          <div class="run-stats">
            <div class="run-stat">
              <span class="icon">ðŸ‘‘</span>
              <span class="label">Bosses:</span>
              <div class="boss-progress">${bossMarkers}</div>
            </div>
            <div class="run-stat deaths ${deathsClass}">
              <span class="icon">ðŸ’€</span>
              <span class="label">Deaths:</span>
              <span class="value">${deaths}</span>
            </div>
          </div>
        </div>
      `;
    }

    function updateRunProgress(data) {
      const card = document.querySelector(`[data-run-id="${data.runId}"]`);
      if (!card) return;

      const percentageEl = card.querySelector('.progress-percentage');
      const fillEl = card.querySelector('.progress-bar .fill');
      const deathsEl = card.querySelector('.run-stat.deaths .value');
      const deathsStat = card.querySelector('.run-stat.deaths');

      if (data.progress?.percentage !== undefined) {
        percentageEl.textContent = `${data.progress.percentage.toFixed(0)}%`;
        fillEl.style.width = `${data.progress.percentage}%`;
      }

      if (data.deaths !== undefined) {
        deathsEl.textContent = data.deaths;
        if (data.deaths === 0) {
          deathsStat.classList.add('zero');
        } else {
          deathsStat.classList.remove('zero');
        }
      }

      if (data.progress?.bossesKilled !== undefined) {
        const bossMarkers = card.querySelectorAll('.boss-marker');
        bossMarkers.forEach((marker, i) => {
          if (i < data.progress.bossesKilled) {
            marker.classList.add('killed');
          }
        });
      }
    }

    function startTimerUpdates() {
      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const cards = document.querySelectorAll('.run-card');
        cards.forEach(card => {
          const startTime = parseInt(card.dataset.start);
          const parTime = parseInt(card.dataset.par);
          const timerEl = card.querySelector('.progress-timer');

          if (startTime && timerEl) {
            const elapsed = Date.now() - startTime;
            timerEl.textContent = `${formatTime(elapsed)} / ${formatTime(parTime)}`;
            timerEl.className = `progress-timer ${getTimerClass(elapsed, parTime)}`;
          }
        });
      }, 1000);
    }

    function getTimerClass(elapsed, parTime) {
      if (!parTime) return '';
      const ratio = elapsed / parTime;
      if (ratio >= 1) return 'overtime';
      if (ratio >= 0.9) return 'warning';
      return '';
    }

    function formatTime(ms) {
      if (!ms || ms < 0) return '00:00';
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
