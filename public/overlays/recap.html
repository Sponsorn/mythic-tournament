<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M+ Tournament - Run Recap</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/recap.css">
</head>
<body>
  <div class="recap-container">
    <div class="recap-card hidden" id="recapCard">
      <div class="recap-header">
        <div class="recap-status" id="recapStatus">Run Complete</div>
        <div class="recap-team" id="recapTeam">Team Name</div>
        <div class="recap-dungeon">
          <span id="recapDungeon">Dungeon Name</span>
          <span class="recap-level" id="recapLevel">+0</span>
        </div>
      </div>

      <div class="recap-body">
        <div class="recap-times">
          <div class="time-stat">
            <div class="label">Final Time</div>
            <div class="value" id="recapTime">00:00</div>
          </div>
          <div class="time-stat" id="timeRemainingStat">
            <div class="label">Time Remaining</div>
            <div class="value" id="recapRemaining">+00:00</div>
          </div>
        </div>

        <div class="recap-stats">
          <div class="recap-stat">
            <div class="icon">â­</div>
            <div class="label">Upgrades</div>
            <div class="upgrades" id="recapUpgrades"></div>
          </div>
          <div class="recap-stat deaths" id="deathsStat">
            <div class="icon">ğŸ’€</div>
            <div class="label">Deaths</div>
            <div class="value" id="recapDeaths">0</div>
          </div>
          <div class="recap-stat points">
            <div class="icon">ğŸ“Š</div>
            <div class="label">M+ Rating</div>
            <div class="value" id="recapRating">0</div>
          </div>
        </div>

        <div class="recap-score">
          <div class="score-earned">
            <div class="label">Points Earned</div>
            <div class="value" id="recapPoints">0</div>
          </div>
          <div class="rank-info">
            <div class="label">Current Rank</div>
            <div class="rank-display">
              <span class="rank-change" id="rankChange"></span>
              <span class="rank-current" id="currentRank">#1</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/socket-client.js"></script>
  <script>
    const client = initTournamentClient();
    const recapCard = document.getElementById('recapCard');

    let hideTimeout = null;

    client.on('recap:show', (data) => {
      showRecap(data.recap, data.duration);
    });

    client.on('run:complete', (data) => {
      // Auto-show recap on run complete
      showRecap(data.recap, 15000);
    });

    function showRecap(recap, duration = 15000) {
      if (!recap) return;

      // Clear any pending hide
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }

      // Populate data
      document.getElementById('recapTeam').textContent = recap.teamName;
      document.getElementById('recapDungeon').textContent = recap.dungeonName;
      document.getElementById('recapLevel').textContent = `+${recap.keystoneLevel}`;
      document.getElementById('recapTime').textContent = formatTime(recap.duration);
      document.getElementById('recapDeaths').textContent = recap.deaths || 0;
      document.getElementById('recapRating').textContent = recap.blizzRating || 0;
      document.getElementById('recapPoints').textContent = recap.points || 0;

      // Time remaining
      const timeRemaining = recap.timeRemaining;
      const timeRemainingStat = document.getElementById('timeRemainingStat');
      const remainingEl = document.getElementById('recapRemaining');

      if (timeRemaining >= 0) {
        remainingEl.textContent = `+${formatTime(timeRemaining)}`;
        timeRemainingStat.classList.add('remaining');
        timeRemainingStat.classList.remove('overtime');
      } else {
        remainingEl.textContent = `-${formatTime(Math.abs(timeRemaining))}`;
        timeRemainingStat.classList.add('overtime');
        timeRemainingStat.classList.remove('remaining');
      }

      // Timed status
      const statusEl = document.getElementById('recapStatus');
      if (recap.timed) {
        recapCard.classList.add('timed');
        recapCard.classList.remove('depleted');
        statusEl.textContent = 'Key Timed!';
      } else {
        recapCard.classList.add('depleted');
        recapCard.classList.remove('timed');
        statusEl.textContent = 'Depleted';
      }

      // Upgrades
      const upgradesEl = document.getElementById('recapUpgrades');
      const upgrades = recap.upgrades || 0;
      upgradesEl.innerHTML = Array.from({ length: 3 }, (_, i) => {
        return `<div class="upgrade-star ${i < upgrades ? 'earned' : ''}"></div>`;
      }).join('');

      // Deaths styling
      const deathsStat = document.getElementById('deathsStat');
      if (recap.deaths === 0) {
        deathsStat.classList.add('zero');
      } else {
        deathsStat.classList.remove('zero');
      }

      // Rank - get from current leaderboard state
      updateRankDisplay(recap.teamName);

      // Show card
      recapCard.classList.remove('hidden', 'exiting');
      recapCard.classList.add('visible');

      // Schedule hide
      hideTimeout = setTimeout(() => {
        hideRecap();
      }, duration);
    }

    function hideRecap() {
      recapCard.classList.add('exiting');
      recapCard.classList.remove('visible');

      setTimeout(() => {
        recapCard.classList.add('hidden');
        recapCard.classList.remove('exiting');
      }, 300);
    }

    function updateRankDisplay(teamName) {
      const leaderboard = client.getLeaderboard();
      const entry = leaderboard.find(e => e.teamName === teamName);

      const currentRankEl = document.getElementById('currentRank');
      const rankChangeEl = document.getElementById('rankChange');

      if (entry) {
        currentRankEl.textContent = `#${entry.rank}`;

        const rankDiff = entry.previousRank - entry.rank;
        if (rankDiff > 0) {
          rankChangeEl.textContent = `â–²${rankDiff}`;
          rankChangeEl.className = 'rank-change up';
        } else if (rankDiff < 0) {
          rankChangeEl.textContent = `â–¼${Math.abs(rankDiff)}`;
          rankChangeEl.className = 'rank-change down';
        } else {
          rankChangeEl.textContent = 'â€”';
          rankChangeEl.className = 'rank-change same';
        }
      } else {
        currentRankEl.textContent = '#-';
        rankChangeEl.textContent = '';
        rankChangeEl.className = 'rank-change';
      }
    }

    function formatTime(ms) {
      if (!ms || ms < 0) ms = 0;
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>
